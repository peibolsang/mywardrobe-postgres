# Agent Self-Improvement Notes

## IMPORTANT
- Any architecture or data-model change implemented in code MUST be reflected in `AGENTS.md` in the same session.
- Any authentication/authorization change implemented in code MUST be reflected in `AGENTS.md` in the same session.

## 2026-02-08
- Context: User reported Vercel showing newer wardrobe data while local showed older data.
- What went right: Quickly verified read-path cache (`unstable_cache`) and write-path invalidation (`revalidateTag('garments')`) in code.
- What went wrong: Initial read attempt for route-group paths failed because shell globbed unquoted parentheses.
- Correction applied: Quoted paths like `app/(main)/viewer/page.tsx` when inspecting files.
- Working hypothesis that matched code: Local and Vercel have separate Next.js data caches; both can point to the same DB but still return different cached snapshots.
- Reminder for future sessions: When data differs by environment, inspect cache scope before assuming DB mismatch.
- Additional correction: Making route handler `GET` accept an optional request broke Next's generated route types; fixed by moving wardrobe reads into `lib/wardrobe.ts` and calling that from both pages and API routes.
- New defect pattern: Free-text lookup values (materials) were silently discarded when not present in the lookup table because actions only selected existing IDs. Fix was to upsert missing lookup rows first, then resolve IDs.
- UI implementation note: For custom dropdown/combobox controls in forms, add hidden inputs for non-native fields (for example `type`) so `FormData` includes the selected value on submit.
- Data model migration note: For gradual normalization (`garments.type` -> `garments.type_id`), execute SQL in two phases: create/backfill first, deploy app code second, then enforce `NOT NULL` and drop legacy column.
- Repeatable pattern: If a field is lookup-backed and UI allows creating new values (for example materials/colors), server actions must upsert missing lookup rows before inserting junction rows.
- Security lesson: Protect editor/admin behavior at three layers, not one:
  1) route-level guards,
  2) API endpoint guards,
  3) server-action/mutation guards.
- Consistency lesson: If write logic touches multiple tables (main row + junction tables), always use a DB transaction; delete+insert patterns without a transaction can silently corrupt state on partial failure.
- Form serialization lesson: Never serialize arbitrary user-entered array values with comma-join. Use JSON array serialization and parse on the server.
- UX reliability lesson: `useFormStatus()` alone is not reliable when using custom `onSubmit` with `preventDefault`; wire explicit pending state from transitions/uploads into submit controls.
- Validation lesson: Validation helpers are useless unless invoked in submit flow; ensure `validateForm` (or equivalent) runs before action dispatch.
- Field-removal lesson: Removing a domain field must be done end-to-end (types, queries, server actions, form schema, UI rendering, docs, and DB migration), not only hidden from UI.
- Vocabulary governance lesson: For each controlled-value field, explicitly document whether it is DB-driven or schema-driven, and keep UI/server behavior aligned with that source of truth.
- Product insight note: The current `/stats` view only charts garment type share, but existing garment fields already support richer analytics (coverage by weather/occasion/time/place, material-weighted composition, favorites bias, and combinational gaps). Suggest prioritizing "decision-support" stats over static distribution charts.
- Implementation note: Upgraded `/stats` v1 from a single pie chart to server-computed decision analytics (coverage/gap alerts, occasion x weather readiness matrix, and favorites-vs-total distribution deltas) using existing garment fields and schema enums.
- Tooling note: `npm run lint` currently triggers Next.js interactive ESLint setup prompt in this repo (non-CI safe); use `npx tsc --noEmit` as a temporary non-interactive safety check until ESLint config is committed.
- UX correction note: Preserve an at-a-glance garment type percentage view even when adding deeper analytics, and attach short explanatory tooltips to each stats section to reduce interpretation friction.
- Product prioritization note: If users find behavior-based comparisons confusing, replace with materially grounded metrics (for example material-weighted composition) that are simpler to interpret and directly tied to source data quality.
- Data backfill lesson: For taxonomy migrations (like `suitable_time_of_day`), provide a deterministic SQL inference script with weighted signals from related dimensions and run it transactionally (insert canonical values, rebuild junction rows, include fallback for low-signal rows).
- Calibration lesson: First-pass inference can overfit to broad contextual signals (for example place/weather) and collapse to one bucket; mitigate by requiring confidence margin for specific-class assignment and defaulting ambiguous rows to "all day".
- AI feature implementation note: For wardrobe recommendation agents, enforce structured model output (schema), keep recommendations wardrobe-ID-only, and enrich display data server-side from DB records to prevent hallucinated garment attributes.
- AI calibration note: For free-text wardrobe assistants, split "interpretation" and "selection" into separate model steps and blend model confidence with deterministic tag-overlap scoring to avoid unstable low-confidence outputs.
- AI tool-use note: For prompts with geographic place mentions, add an external weather-enrichment step (location extraction + geocode + weather API) and inject a concise weather summary into both intent parsing and recommendation prompts.
- Agent integration note: Prefer true model-invoked tool calling (`generateText` + `tool`) over pre-processing heuristics when users explicitly request tool semantics and dynamic tool invocation.
- Ops reliability note: Weather tool providers are environment-dependent; if one API host is blocked/unresolvable, switch tool execution to a reachable provider (OpenWeather in this case) while preserving the same model-invoked tool contract.
- Security hardening note: OpenAI-backed endpoints should enforce defense-in-depth beyond auth: same-origin request validation, endpoint rate limiting, and no logging of raw user prompts/interpreted private context.
- Form validation bugfix note: In create flows with deferred upload, validating `file_name` string alone is incorrect; required-image validation must also accept a selected file in the file input before upload happens.
- Lookup integrity note: For controlled single-select lookups (`style`, `formality`), never silently fallback to null on unresolved values. Resolve case-insensitively and fail fast with explicit validation errors to prevent accidental data loss during create/update.
- UX flow note: For edit forms that currently remain in-place after successful save, prefer server-action redirect to the canonical read-only detail route and trigger success toast there via one-time URL flag consumption (`?updated=1` -> toast -> `router.replace` without flag).
- Routing note: Intercepted routes for modal detail views must be scoped to the originating subtree (for example under `viewer/(..)garments`) rather than shared layout root, otherwise unrelated navigations/redirects (like post-save from `/editor`) can be intercepted and render modal overlays unexpectedly.
- Editor enum UX note: For schema-enum selects (for example `style`/`formality`), include the current persisted value in rendered options when it is not an exact option match; otherwise legacy/case-variant values render as blank in edit mode and trigger false "required" save errors.
- Enum canonicalization note: When hydrating editor state, normalize persisted enum-backed values case-insensitively to schema enums (for example `Vintage` -> `vintage`) before rendering/select binding; keep raw fallback only when no canonical option exists.
- Taxonomy migration note: When replacing controlled enum vocab (for example `formality`), update `schema.json` and provide a transaction-safe SQL remap script that (a) inserts canonical lookup rows, (b) remaps existing FK references, (c) removes unreferenced legacy rows, and (d) fails fast if non-canonical references remain.
- Style taxonomy note: If removing style options from schema enums, pair UI enum removal with explicit DB remap for affected styles (for example `casual`/`smart casual`) so existing garments remain editable and never fail server-side style validation.
- Controlled-vocab typo note: If an enum label typo ships (`Elevated Causal`), correct both app schema and DB lookup values with a dedicated follow-up migration that remaps existing foreign keys and removes the typo row safely.
- Navigation cache note: If edit forms show stale/missing values only on client navigation (but recover on hard refresh), disable prefetch on edit-entry links and run a one-time `no-store` reconciliation fetch on editor mount for the target record.
- Viewer search UX note: Implemented a `Cmd/Ctrl+K` command-style dialog on `/viewer` using shadcn `CommandDialog`, with client-side case-insensitive partial matching across `model`, `type`, and `brand`, thumbnail-first result rows, and direct navigation to `/garments/[id]`.
- Routing behavior note: In `/viewer`, command-palette result selection must use hard navigation (`window.location.assign`) when the expected outcome is full garment detail page; soft `router.push` can trigger intercepted modal routes.
- CMDK performance note: For large local lists in `cmdk`, defer filtering until query length >= 3 and apply a short input debounce (~120ms) to remove perceived keystroke lag.
- CMDK UX note: Highlighting matched substrings in results (model/type/brand) improves scan speed; implement with regex split + escaped query and style matches with a yellow background.
- Viewer quick-filter note: Added season quick filters (`winter|summer|fall|spring`) tied to `suitable_weather`, and persisted selection via `season` query param so filter state survives reload/share links.
- Viewer season quick-filter UX note: Replaced text chips with icon-only buttons (snowflake/sun/leaf/flower) while preserving accessible labels via `aria-label` + `title`.
- Viewer season control UX note: Consolidated season quick filters into a single dropdown trigger, showing vertically stacked season icons in a shadcn `DropdownMenu` to reduce toolbar clutter.
- AI travel planner note: Added `/ai-look` "Pack for Travel" mode with structured inputs (`destination`, `startDate`, `endDate`, `reason`), per-day weather enrichment (forecast + seasonal fallback), day-by-day look generation, strict no-repeat for first 4 days, and partial-plan return via `skippedDays`.
- Travel packing rule note: Updated travel planner constraints so first-4-day no-repeat excludes bottoms and footwear, footwear is capped to one pair across the trip, and day 1 + final day are explicitly generated as airport/commute-appropriate looks.
- Travel weather fallback note: When exact API forecast is unavailable for requested dates, planner now queries the LLM for destination/month average climate conditions and uses that for day-level weather intent before falling back to deterministic seasonal inference.
- Travel strictness note: Added hard place/occasion gating per day in travel planning (pre-filter eligible wardrobe + post-validate final lineup), so transit days require airport/commute tags and stay days follow strict reason-specific tags (office/business or vacation city/active with conditional beach).
- AI pipeline consistency note: Updated travel mode to match single-look architecture by adding a per-day Step 1 intent-interpretation pass (canonical structured intent) before Step 2 recommendation generation.
- Travel robustness note: For one-footwear-across-trip constraints, add deterministic post-processing to normalize model output (collapse multi-footwear selections to a single locked pair) before deciding to skip a day.
- Travel rule refinement: Footwear-lock now applies to stay days only (commute days exempt), and all garments used on travel days are reserved from reuse on in-between stay days.
- Travel constraint update: Removed the first-4-day no-repeat rule entirely; travel planning now allows repeats as needed while keeping strict place/occasion, commute-reserve, and footwear constraints.
- Travel office-mapping note: Expanded Office strict constraints to include additional acceptable places (`Workshop`, `Creative Studio / Atelier`, `Metropolitan / City`) and occasion (`Casual Social`) while retaining office/business options.
- Travel transit-day reliability note: Enforced strict eligible-ID pool filtering before validation and added last-travel-day fallback to reuse day-1 transit lineup (when still eligible) to avoid unnecessary skips under identical transit constraints.

## 2026-02-09
- Context: Travel pack agent was repeating looks across days and occasionally returning incomplete outfits without top-bottom-footwear coverage.
- What went right: Added deterministic post-generation normalization (core silhouette enforcement + top-to-bottom ordering + anti-duplicate/overlap checks) so model variance no longer directly leaks into output quality.
- What went wrong: Existing travel fallback intentionally reused day-1 lineup on final travel day, which reintroduced repeats even when alternatives existed.
- Correction applied: Removed final-day forced reuse behavior and replaced it with diversity-aware retries plus strict duplicate rejection when fresh pool depth is sufficient.
- Optimization note: Large eligible wardrobes were causing prompt bloat and repeated high-salience picks; fixed by scoring and capping a travel-day candidate subset (category quotas + novelty weighting) before model generation.
- Reliability note: Single-look mode now also applies deterministic silhouette completion and validation so responses consistently include top + bottom + footwear when wardrobe data permits it.
- Travel-pack completeness note: Updated travel mode to require four garment categories per day (`outerwear` + `top` + `bottom` + `footwear`), with explicit prompt rule, schema minimum of 4 IDs, and deterministic server-side enforcement/validation.
- Office baseline update note: Travel Office mode now favors styles `minimalist`/`vintage`/`classic`, formality `Elevated Casual` (fallback `Business Casual`), and occasions `Casual Social`/`Date Night / Intimate Dinner`/`Outdoor Social / Garden Party`; strict Office-day occasion gating was aligned to the same set so the preference is enforceable in eligibility filtering.
- Stats UI clarity note: In Coverage and Gaps, truncating each section to 6 rows caused confusion against full coverage totals (for example 9/9 while showing only 6). Updated UI to render all options in each section.
- AI Look tab UX note: Replaced the mode toggle-like control with semantic tabs rendered outside the main card (`role=tablist`/`tab`), and removed redundant main-card title/subtitle to reduce visual noise.
- Travel packing constraint note: Added a hard single-outerwear rule for travel mode (one jacket/coat across departure, stay, and return days), including trip-wide preselection of an outerwear candidate that satisfies each day’s place/occasion/weather constraints plus deterministic per-day lock validation.
- Travel rule interaction fix: commute-day reservation previously blocked the locked trip outerwear on stay days, causing false one-outerwear failures; fixed by exempting the locked outerwear from transit reservation blocking and from transit-reserved insertion.
- Travel loading UX note: Added full-structure skeletons for `/ai-look` travel mode that render one day-card placeholder per requested travel day while plan generation is pending, reducing layout shift when results hydrate.
- AI tab state UX note: Scoped result rendering by active mode so travel output/skeletons only show in `Pack for Travel` and single-look output only shows in `AI Look`, preventing cross-tab visual leakage.
- AI single-look guardrail note: Enforced fixed four-piece output (`outerwear + top + bottom + footwear`) with deterministic category-based normalization to prevent invalid category duplication (for example two pants) in `/ai-look` single mode.
- AI single-load UX note: Added screenshot-matching loading skeletons for `AI Look` results (title bar, intent-details strip, 4 lineup tiles, rationale lines) and clear previous results at request start to reduce layout shift.

## 2026-02-10
- Security hardening note: `/api/ai-look` now enforces a server-side maximum travel span (21 days) before any expensive per-day generation path runs, preventing single-request cost amplification.
- Rate-limit hardening note: Replaced owner API limiting from in-memory/IP-keyed only to owner-scoped persistent DB-backed windows (minute + hour) to resist multi-instance bypass; keep an in-memory fallback path only for DB limiter outages to avoid feature downtime.
- UI overflow note: `AI Look` page had baseline vertical scroll due to `min-h-screen` under a sticky `h-16` top nav; fixed by switching container min-height to `calc(100vh - 4rem)`/`calc(100dvh - 4rem)` so idle tab no longer overflows.
- CMDK export note: Added a new `Actions` command in `/viewer` command palette for `Export Wardrobe as JSON` with a right-aligned `J` chip; selecting it switches the palette into a dedicated export view (garment list hidden), includes a back icon in the input bar to return to normal search, and a copy icon/button to copy the full JSON payload.
- CMDK export UX refinement: In export view, removed active command input and replaced it with fixed helper text `Back to search` so users don’t interact with search while viewing command output.
- CMDK export sizing fix: Export-result container had `max-h-[70vh]`, which made the dialog larger than normal search mode; changed to the same results cap (`max-h-[300px]`) as command list so palette dimensions stay consistent across views.
- CMDK export polish: Converted export results panel to a fixed-height flex layout so textarea spacing at the bottom stays comfortable, and removed command-root focus outline to prevent transient gray border artifacts after executing export command.
- CMDK shortcut refinement: Limited export keyboard shortcut to uppercase `J` only; lowercase `j` is no longer intercepted so it can be used as normal search input text.

## 2026-02-11
- Stats caching correction note: `/stats` previously consumed production `unstable_cache` data and could remain stale indefinitely when DB changes occurred outside server actions; fixed by forcing fresh reads in stats (`getWardrobeData({ forceFresh: true })`) and marking the route dynamic.
- Cache resilience note: Added a 5-minute TTL (`revalidate: 300`) to shared `getWardrobeData()` production cache so viewer/API consumers self-heal from out-of-band DB updates even without explicit `revalidateTag`.
- AI rationale consistency note: `/api/ai-look` previously returned model-authored rationale generated before lineup normalization, causing garment-name drift versus final `lineup`; fixed by generating rationale server-side from finalized lineup + canonical intent/weather context for both single and travel modes.
- AI debugging note: Added explicit server log for single-look Step 1 interpreter output (`[ai-look][single][step-1][interpreted-intent]`) to inspect raw LLM intent JSON before recommendation generation.
- AI debugging refinement note: Added companion server log for normalized canonical intent (`[ai-look][single][step-1][canonical-intent]`) so raw-vs-canonical mapping can be compared in one request.
- AI tuning note: Increased single-look Step 1 interpreter temperature from `0` to `0.8` to allow more varied intent inference while keeping schema/canonical guardrails.
- Taxonomy label update note: Replaced place enum label `Hospitality (Indoor)` with `Home / WFH` in `public/schema.json` and added SQL migration script `scripts/sql/rename-hospitality-indoor-to-home-wfh.sql` to remap `suitable_places` rows and junction-table references safely.
- Weather grounding note: Single-look mode now parses explicit prompt dates (for example `February 11th 2026`), resolves weather deterministically by location/date server-side, logs resolution metadata, and overrides canonical weather intent with resolved tags when available to prevent generic `all season` drift.
- Weather grounding refinement note: Removed single-look prompt date parsing and date-based weather resolution; single-look now always resolves weather from current conditions at the indicated place (including `today`/`now`/`tomorrow` prompts) and uses that to override generic interpreted weather when available.
- AI temperature tuning note: Set two-step generation temperatures to `0.3` for Step 1 intent interpretation and `0.7` for Step 2 recommendation in both single-look and travel flows.
- Rationale tone note: Refined server-generated rationale to be crisp and intent-focused only (occasion/place/weather/formality/style fit), removing garment-level descriptions and material callouts.
- Rationale polish note: Further improved rationale readability by removing technical prefixes (for example `Intent focus`), de-duplicating weather statements, and producing concise natural-language weather highlights without truncation artifacts.
- Rationale depth note: Expanded server-generated rationale into a richer multi-sentence narrative (context, day-flow fit, style/formality fit, weather fit, and cohesion) while still avoiding garment/material descriptions and technical-sounding phrasing.
- Panelist diversity note: Single-look Step 2 now attempts six candidates (`2 per panelist`), validates/normalizes them server-side, reranks with recency and overlap penalties, and returns one top look per panelist to reduce near-duplicate outputs for similar prompts.
- Personalization memory note: Added persistent `ai_look_lineup_history` (single mode) so repeated requests can be diversified without making generation brittle; history read/write failures are treated as non-fatal warnings.
- UI clarity note: Replaced single-look one-result card with a manual one-card carousel (prev/next + dots) to expose three panelist perspectives without changing the page layout density.
- Migration workflow note: When users prefer explicit schema control, provide a dedicated idempotent SQL script (`scripts/sql/create-ai-look-lineup-history.sql`) even if runtime auto-create guards exist.
- Migration enforcement note: Removed runtime auto-create for `ai_look_lineup_history`; single-look recency memory now depends on running `scripts/sql/create-ai-look-lineup-history.sql` before use.
- Robustness note: Guarded single-look client rendering against malformed/partial API payloads by parsing response shape and using safe array access before `.map`, preventing runtime crashes during iterative API changes.
- Product-direction note: Reverted from panelist multi-look output to a single-output diversified reranker flow (up to 6 candidates -> 1 `primaryLook`) to reduce repetition without forcing multi-card UX.
- Rationale integrity note: Removed model-authored rationale sentence appending in single-look finalization and strengthened weather-note cleanup (`not found`/assumption patterns + weather sentence stripping when live weather exists) to prevent lineup drift and repetitive weather phrasing.
- Diversity hardening note: Added explicit recent-signature avoidance in step-2 prompting plus hard no-repeat/low-overlap selection filters (when alternatives exist), and injected recent-ID novelty bias into normalization/fallback scoring to reduce back-to-back duplicate looks.
- Travel persistence note: Added cross-request travel-day anti-repeat memory using `ai_look_travel_day_history` keyed by a normalized travel fingerprint (`destination|reason|startDate|endDate`), with hard historical-signature avoidance when alternatives exist, graceful fallback when they do not, and best-effort history read/write logging.
- Travel reliability note: Added an extra relaxed-diversity fallback attempt for travel-day generation when silhouette/packing validity fails, so strict day constraints remain enforced while avoiding avoidable `skippedDays` regressions introduced by diversity pressure.
- Feature-scoping note: For anchored AI look requests, define strict vs soft anchor semantics and preserve non-anchored path parity in spec first; this avoids regressions in single/travel flows when introducing context-bound CMDK commands.
- Anchored look implementation note: Added garment-detail CMDK action (`Generate look around this garment`) that routes to `/ai-look` with anchor params, plus strict/soft anchor enforcement in single-look candidate normalization and fallback while keeping non-anchored behavior unchanged.
- Garment CMDK UX note: Added garment-detail action commands for JSON export (in-dialog copyable textarea), copy link, next/previous navigation, and viewer handoff (`Find Matching Pieces`), while preserving viewer-style search threshold behavior (`>=2` chars) and uppercase-only hotkeys for `E`/`G`.
- Command palette visual note: Added consistent leading icons across viewer and garment CMDK action items while keeping right-side shortcut chips, improving scanability without changing command semantics.
- Viewer CMDK automation note: Added `Season Clothes (Auto)` action (plus uppercase `S` shortcut when search input is empty) that infers season from browser date/time/timezone and applies the existing `season` URL filter, preserving current favorites and other selected filters.
- Viewer CMDK toggle UX note: Auto-season action label is now dynamic by state (`Season Clothes (Auto: <season>)` vs `Clear Season Clothes (Auto: <season>)`) and matches toggle behavior for the current inferred season.

## 2026-02-13
- Context: Single-look AI logs showed Step-1 interpreted notes claiming weather unavailable while final rationale displayed live weather for the same request.
- What went right: Traced the full single-mode flow and confirmed weather can be resolved after interpretation via forced tool call/direct fallback, which explained the contradictory outputs.
- What went wrong: Canonical note cleanup used `cleaned || interpreted`, which reintroduced the unavailable-weather sentence whenever cleanup removed the entire note.
- Correction applied: Canonical notes now reconcile with resolved weather state (when weather context exists, unavailable-status claims are removed without falling back to contradictory text).
- Reliability note: Added normalized weather-query variants (including parenthetical-location cleanup) before OpenWeather lookup, improving hit rate for prompts like `Aviles, Asturias (Spain)`.
- Observability note: Added explicit single-look weather-resolution logging (`weatherStatus`, `weatherContextSource`, location hint, resolved weather tags) to make tool/fallback behavior auditable in server logs.
- Constraint-hardening note: AI Look now hard-blocks weather-incompatible garments across both single and travel modes by enforcing per-garment weather compatibility in normalization, candidate replacement, day eligibility filters, and final day-violation checks; if required silhouette categories are unavailable under the resolved weather tags, the API returns a clear 422 instead of silently selecting mismatched pieces.
- Prompt curation note: Added Albert Muzquiz as a fourth expert persona in `app/api/ai-look/prompt.md` to expand panel-style guidance while preserving existing system prompt structure.
- Material-intent rule note: Added deterministic material-composition scoring tied to weather/place/occasion/time across single and travel flows (selection, normalization, and confidence scoring), and reinforced it in prompt instructions so final recommendations account for material fit beyond tag overlap.
- Intent-architecture note: Refactored Step 1 intent interpretation to context-only (`weather`, `occasion`, `place`, `timeOfDay`, `notes`) and moved `formality`/`style` into deterministic server-side derivation from those context dimensions (single + travel), ensuring consistent context → styling causality.
- Rules v2 implementation note: Added deterministic structured weather profiles across single/travel (`tempBand`, precipitation, wind, humidity, wet-surface risk, confidence) and threaded them into scoring, normalization, and observability logs.
- Rules v2 priority note: Enforced category-aware hard constraints with explicit priority (`weather` first, then `occasion/place`, then `time`, then `style/formality`) and added wet-material hard conflict blocking for outerwear/footwear in high wet-risk conditions.
- Feedback loop note: Implemented owner-only `POST /api/ai-look/feedback` plus manual Neon SQL migration `scripts/sql/create-ai-look-feedback.sql`; `/ai-look` UI now captures thumbs up/down feedback with optional downvote reason for both single and travel day cards.
- Debugging observability note: Added request-scoped logging correlation for AI Look APIs via `requestId` (returned in all `/api/ai-look` and `/api/ai-look/feedback` responses) and introduced `AI_LOOK_DEBUG=1` gating for verbose structured `console.info` traces.
- Rules v2 quick-win note: tightened deterministic material-target precedence to avoid contradictory outputs (for example cold/wet contexts no longer keep `breathable` as a preferred target).
- Wet-weather guardrail note: extended wet-material hard blocking to `wetSurfaceRisk = medium` for outerwear/footwear when absorbent share is high and technical share is low.
- Feedback-loop quick-win note: single-look reranker now consumes recent context-matched downvotes from `ai_look_feedback` and applies penalties by signature/garment overlap plus reason-keyword signals (rain/material/formality/style/time).
- Feedback UX refinement note: AI Look thumbs selection now uses neutral selected styling (outline + subtle grey fill) instead of primary button treatment, preserving action hierarchy.
- Feedback submission UX note: Downvote send actions are now right-aligned with extra top spacing, and feedback confirmation/errors use toast notifications instead of inline helper text.
- Duplicate-submit guard note: After successful feedback submission (`single` and per-day `travel`), thumbs actions are locked (`submitted`) and related controls are disabled to prevent duplicate writes for the same generated look.
- Single skeleton parity note: Removed downvote textarea/button placeholders from single-look loading skeleton so it mirrors the default pre-selection feedback state.
- Debugging payload note: Added structured final-output logs for both single and travel modes that include full lineup garment objects (`garments` array with all available properties), rationale text, and key context metadata so debugging can rely on copy-pastable JSON instead of screenshots.
- Wet-weather safety gate note: Added deterministic rain-ready hard validation for outerwear/footwear under active wet contexts (precipitation + medium/high wet risk), using material + feature + type heuristics, and wired it into single/travel hard-constraint checks plus rule traces and 422 preflight for missing rain-safe categories.
- Style-directive v1 note: Added deterministic extraction of style aliases + menswear reference signals from user prompts, merged directives into derived profile (style/material/formality bias), injected directives into Step 2 prompting, and integrated style-directive fit into deterministic rerank, final output logs, and rule traces.

## 2026-02-14
- Travel robustness note: Added a travel-only coverage-aware constraint envelope for commute days that keeps outerwear/footwear on strict airport/transit constraints while allowing top/bottom deterministic relaxation (place/occasion) when strict coverage lacks required categories, reducing `skippedDays` from missing bottoms.
- Travel validation alignment note: Day-level place/occasion violation checks now use category-aware effective constraints in travel mode, so deterministic post-generation validation matches the same relaxation policy used for eligibility filtering.
- Travel observability note: Added `[ai-look][travel][constraints][relaxed]` logs with strict vs effective coverage and missing-category deltas to debug why/when commute-day relaxation activates.
- Weather fallback consistency note: Improved climate-fallback weather profile inference by expanding precipitation keyword detection (`rainy`, `showers`, `stormy`, etc.), and inferring wind/humidity bands from textual climate descriptors so seasonal fallback profiles better reflect rainy/windy summaries.
- Regression fix note: Trip-wide locked outerwear selection now enforces wet-weather safety across all travel days; when wet safety is active, non-rain-ready outerwear is excluded from lock candidates to prevent all days from failing with `wet-weather safety rule` after lock-in.
- Travel weather-consistency note: Day-level interpreted weather in travel mode now merges with strict fallback weather tags instead of replacing them, preventing LLM weather drift (for example `cold` -> `cool`) from invalidating the locked outerwear and causing false `one-outerwear` skips.
- Planning note: Added spec `vibe/specs_single_mode_temporal_weather_fallback.md` to bring travel-style date-aware weather fallback (forecast -> LLM monthly climate -> deterministic seasonal) into single mode for prompts like `tomorrow`, `this Friday`, and `next week`.
- Single temporal-weather implementation note: Implemented deterministic temporal parsing in single mode (`today/now`, `tomorrow`, `this|next <weekday>`, `next week`, explicit dates), plus date-aware weather resolution that reuses travel weather fallback chain for single-date and date-range prompts.
- Single weather-source observability note: Added temporal resolution/weather metadata logs in single mode (`[ai-look][single][step-1][temporal-resolution]` and extended weather-resolution payload with target date/range + temporal status/source).
- Rationale wording note: Updated weather summarization to avoid “Current weather …” phrasing when context corresponds to a future date/range fallback summary.
- Single-note hygiene note: Added deterministic cleanup of stale Step-1 style-disclaimer text (for example “style noted but not categorized/output”), so canonical notes no longer contradict directive-based style handling.
- Single fingerprint note: `buildSingleRequestFingerprint` now uses resolved temporal target date/range when available (instead of always runtime date), improving history/diversity behavior for future-date prompts.
- Confidence normalization note: Added `normalizeModelConfidence` heuristic (0.x => x100, 1..10 => x10, else clamp 0..100) and applied it in both single-candidate validation and travel day confidence calculation to mitigate LLM confidence-scale drift.
- Style-directive dictionary coverage note: Expanded deterministic style alias mapping for military/heritage phrasing (for example `military`, `military style`, `heritage`, `heritage-inspired`, `fatigue`, `field jacket`) and aligned mapped tags to canonical style enums (`workwear`, `vintage`, `classic`, `outdoorsy`) so Step-1 emits non-empty directives and Step-2 style-fit can influence reranking for these prompts.
- Model upgrade note: Switched AI Look model calls from `gpt-4.1-mini` to `gpt-5-mini` across single-look and travel flows (`generateText` + `generateObject` paths), keeping temperatures and deterministic post-processing unchanged.
- Profile default-location note: Added owner-scoped `user_profile` persistence (`scripts/sql/create-user-profile.sql`, `/api/profile`, `/profile` UI) and wired single-look weather location fallback to `prompt location > profile default location > none`, with explicit `resolvedLocationSource` logging in temporal/weather resolution traces.
- Model compatibility note: Updated AI Look generation calls to `gpt-5-nano` and removed unsupported `temperature` parameters from all OpenAI Responses invocations to eliminate reasoning-model warnings.
- Note hygiene refinement: Expanded deterministic weather-status cleanup to remove stale fallback text like `No specific city/weather provided...` and follow-up `If you want colder/hotter...` guidance when canonical notes are finalized.
- Feedback-schema robustness note: `/api/ai-look/feedback` now accepts larger `derivedProfile.materialTargets` arrays (up to 24) and normalizes/dedupes/caps style/material arrays server-side before persistence, preventing 400 payload rejections when directive-derived material preferences expand.
- Latency rollback note: Reverted AI Look model calls back to `gpt-4.1-mini` and restored previous `temperature` settings (`0`, `0.3`, `0.7`) across climate fallback, interpreter, and candidate-generation paths to recover faster response times versus reasoning-model latency.
- Add-tool framework note: Implemented single-look `selectedTools` request contract (`style`/`reference`), added AI Look UI tool chips, and enforced deterministic directive precedence (`tool-selected > free-text > derived fallback`) with debug logs for requested vs applied tool directives.
- Add-tool UX simplification note: Replaced card-based Add Tool controls (type/value selectors) with a compact `+` dropdown menu (`Style`/`Reference` submenus), removed draft-selection UI state, and kept selected tool chips removable inline.
- Terminology migration note: Renamed menswear `icon` terminology to `reference` across AI Look client/server contracts, directive models, logs, and vibe specs while keeping backward compatibility for legacy payloads that still send `selectedTools[].type = "icon"`.
- Style-dictionary migration planning note: Strengthened `vibe/spec_profile_styles_tool.md` to require DB parity for all rich style-directive fields currently used in `app/api/ai-look/route.ts` (aliases, style/silhouette/material/formality biases), with explicit backfill and parity validation before retiring hardcoded entries.
- Reference-dictionary migration planning note: Strengthened `vibe/spec_profile_references_tool.md` with the same DB parity requirement for rich reference-directive fields (aliases, style/silhouette/material/formality biases), plus backfill/parity validation so AI Look can retire hardcoded reference entries without behavior drift.
- Style catalog implementation note: Added DB-backed style catalog/profile-style plumbing (`scripts/sql/create-profile-style-catalog.sql`, `lib/profile-styles.ts`, `/api/profile/styles`, `/profile` style selector UI) and switched AI Look Step-1 style directive extraction to load style entries from DB instead of hardcoded style dictionary.
- Style-fit scoring refinement note: Updated `computeStyleDirectiveFit` to prioritize unique requested-style coverage (not just repeated per-garment hits), expose explicit diagnostics (`matchedUniqueStyleTagCount`, `missingStyleTags`, `styleCoverageRatio`, `styleTagHitCounts`), and apply stronger penalties for missing requested tags.
- Style-selection robustness note: In single-look reranking, style-aligned pool filtering now first prefers candidates that satisfy both score threshold and minimum unique requested-tag coverage, then gracefully falls back to score-only filtering if coverage-constrained pool is empty.
- Feedback-signal precision note: Refined downvote reason parsing to require stronger mismatch evidence (negative cue + category term for material/formality/style/time; weather can trigger directly), and added `evidenceCounts` to `[ai-look][single][feedback-signals][loaded]` logs to debug why each signal is active.
- Reference profile implementation note: Added DB-backed profile reference stack (`scripts/sql/create-profile-reference-catalog.sql`, `lib/profile-references.ts`, `/api/profile/references`, `/api/profile/references/load`, `/api/profile/references/catalog`) including owner-scoped load/preview/save flow for `Load Opinions`.
- Add-tool reference source note: Replaced hardcoded `Reference` options in `components/ai-look-client.tsx` with `/api/profile/references` tool options and disabled `Reference` picker when no saved references exist.
- AI directive-source migration note: Single-look Step-1 reference directive extraction in `app/api/ai-look/route.ts` now loads reference aliases/directives from DB (`getActiveReferenceDirectiveCatalog(ownerKey)`) for both tool-selected and free-text paths; hardcoded reference dictionary is removed from runtime directive resolution.
- Canonical-style guard note: Added shared style/formality canonicalization utility (`lib/style-taxonomy.ts`) with synonym mapping for legacy non-canonical reference tags (for example `elevated-slouch`, `classic-menswear`) and wired it into reference load/save/read + AI directive assembly, preventing empty `styleBiasTags`/zero style-fit regressions.
- Profile reference UX note: Replaced `Generate Reference` dependency with manual form editing in `Menswear References` (display/source name, aliases, style tags, silhouette, material prefer/avoid, formality), plus saved-reference `Edit` and persistent `Delete` actions through profile API (`DELETE /api/profile/references`), without changes to AI look agent runtime logic.
- Profile reference UX polish note: Implemented prioritized UI improvements in `/profile` Menswear References (editor/list split cards, optional-field disclosure, chip-based style selection, inline required-field completion cues, richer saved-card hierarchy, and saved-reference search/filter) without changing AI server-side logic.
- Profile reference UX follow-up note: Updated `/profile` so the Menswear Reference form is hidden by default and only opens via `Add New` (or `Edit` on an existing card); removed saved-reference search per UX direction.
- Profile reference action-controls note: Replaced Saved Reference `Edit`/`Delete` text buttons with icon-only controls and styled delete in red tones while preserving accessibility labels.
- Profile reference layout note: Adjusted Menswear References card ordering so opening `Add New`/`Edit` displays the form above the saved references list.
- Profile reference validation note: Made `Material Preference` and `Formality Bias` required in the manual reference form (required markers, inline error states, save gating, and submit-time validation).
- Profile reference container note: Removed the outer `Saved References` wrapper card in `/profile` Menswear References section and kept only a lightweight section header + individual reference cards.
- Profile reference card-content note: Simplified saved-reference cards to show only `Style Bias` and `Formality Bias` (both as chips), and aligned both bias section titles to the same visual style.
- Profile reference card-actions note: Moved saved-reference `Edit`/`Delete` icon actions from the bottom row to the top-right of each card header for tighter scanning and quicker access.
- Profile reference card-header alignment note: Aligned saved-reference title and top-right icon actions on the same horizontal row by centering header cross-axis alignment.
- Profile API hardening note: Added same-origin validation for profile mutating endpoints (`/api/profile`, `/api/profile/styles`, `/api/profile/references` POST/DELETE), and removed deprecated `/api/profile/references/load` route after switching to manual reference entry.
