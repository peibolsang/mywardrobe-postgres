# Agent Self-Improvement Notes

## IMPORTANT
- Any architecture or data-model change implemented in code MUST be reflected in `AGENTS.md` in the same session.
- Any authentication/authorization change implemented in code MUST be reflected in `AGENTS.md` in the same session.

## 2026-02-08
- Context: User reported Vercel showing newer wardrobe data while local showed older data.
- What went right: Quickly verified read-path cache (`unstable_cache`) and write-path invalidation (`revalidateTag('garments')`) in code.
- What went wrong: Initial read attempt for route-group paths failed because shell globbed unquoted parentheses.
- Correction applied: Quoted paths like `app/(main)/viewer/page.tsx` when inspecting files.
- Working hypothesis that matched code: Local and Vercel have separate Next.js data caches; both can point to the same DB but still return different cached snapshots.
- Reminder for future sessions: When data differs by environment, inspect cache scope before assuming DB mismatch.
- Additional correction: Making route handler `GET` accept an optional request broke Next's generated route types; fixed by moving wardrobe reads into `lib/wardrobe.ts` and calling that from both pages and API routes.
- New defect pattern: Free-text lookup values (materials) were silently discarded when not present in the lookup table because actions only selected existing IDs. Fix was to upsert missing lookup rows first, then resolve IDs.
- UI implementation note: For custom dropdown/combobox controls in forms, add hidden inputs for non-native fields (for example `type`) so `FormData` includes the selected value on submit.
- Data model migration note: For gradual normalization (`garments.type` -> `garments.type_id`), execute SQL in two phases: create/backfill first, deploy app code second, then enforce `NOT NULL` and drop legacy column.
- Repeatable pattern: If a field is lookup-backed and UI allows creating new values (for example materials/colors), server actions must upsert missing lookup rows before inserting junction rows.
- Security lesson: Protect editor/admin behavior at three layers, not one:
  1) route-level guards,
  2) API endpoint guards,
  3) server-action/mutation guards.
- Consistency lesson: If write logic touches multiple tables (main row + junction tables), always use a DB transaction; delete+insert patterns without a transaction can silently corrupt state on partial failure.
- Form serialization lesson: Never serialize arbitrary user-entered array values with comma-join. Use JSON array serialization and parse on the server.
- UX reliability lesson: `useFormStatus()` alone is not reliable when using custom `onSubmit` with `preventDefault`; wire explicit pending state from transitions/uploads into submit controls.
- Validation lesson: Validation helpers are useless unless invoked in submit flow; ensure `validateForm` (or equivalent) runs before action dispatch.
- Field-removal lesson: Removing a domain field must be done end-to-end (types, queries, server actions, form schema, UI rendering, docs, and DB migration), not only hidden from UI.
- Vocabulary governance lesson: For each controlled-value field, explicitly document whether it is DB-driven or schema-driven, and keep UI/server behavior aligned with that source of truth.
- Product insight note: The current `/stats` view only charts garment type share, but existing garment fields already support richer analytics (coverage by weather/occasion/time/place, material-weighted composition, favorites bias, and combinational gaps). Suggest prioritizing "decision-support" stats over static distribution charts.
- Implementation note: Upgraded `/stats` v1 from a single pie chart to server-computed decision analytics (coverage/gap alerts, occasion x weather readiness matrix, and favorites-vs-total distribution deltas) using existing garment fields and schema enums.
- Tooling note: `npm run lint` currently triggers Next.js interactive ESLint setup prompt in this repo (non-CI safe); use `npx tsc --noEmit` as a temporary non-interactive safety check until ESLint config is committed.
- UX correction note: Preserve an at-a-glance garment type percentage view even when adding deeper analytics, and attach short explanatory tooltips to each stats section to reduce interpretation friction.
- Product prioritization note: If users find behavior-based comparisons confusing, replace with materially grounded metrics (for example material-weighted composition) that are simpler to interpret and directly tied to source data quality.
- Data backfill lesson: For taxonomy migrations (like `suitable_time_of_day`), provide a deterministic SQL inference script with weighted signals from related dimensions and run it transactionally (insert canonical values, rebuild junction rows, include fallback for low-signal rows).
- Calibration lesson: First-pass inference can overfit to broad contextual signals (for example place/weather) and collapse to one bucket; mitigate by requiring confidence margin for specific-class assignment and defaulting ambiguous rows to "all day".
- AI feature implementation note: For wardrobe recommendation agents, enforce structured model output (schema), keep recommendations wardrobe-ID-only, and enrich display data server-side from DB records to prevent hallucinated garment attributes.
- AI calibration note: For free-text wardrobe assistants, split "interpretation" and "selection" into separate model steps and blend model confidence with deterministic tag-overlap scoring to avoid unstable low-confidence outputs.
- AI tool-use note: For prompts with geographic place mentions, add an external weather-enrichment step (location extraction + geocode + weather API) and inject a concise weather summary into both intent parsing and recommendation prompts.
- Agent integration note: Prefer true model-invoked tool calling (`generateText` + `tool`) over pre-processing heuristics when users explicitly request tool semantics and dynamic tool invocation.
- Ops reliability note: Weather tool providers are environment-dependent; if one API host is blocked/unresolvable, switch tool execution to a reachable provider (OpenWeather in this case) while preserving the same model-invoked tool contract.
- Security hardening note: OpenAI-backed endpoints should enforce defense-in-depth beyond auth: same-origin request validation, endpoint rate limiting, and no logging of raw user prompts/interpreted private context.
- Form validation bugfix note: In create flows with deferred upload, validating `file_name` string alone is incorrect; required-image validation must also accept a selected file in the file input before upload happens.
- Lookup integrity note: For controlled single-select lookups (`style`, `formality`), never silently fallback to null on unresolved values. Resolve case-insensitively and fail fast with explicit validation errors to prevent accidental data loss during create/update.
- UX flow note: For edit forms that currently remain in-place after successful save, prefer server-action redirect to the canonical read-only detail route and trigger success toast there via one-time URL flag consumption (`?updated=1` -> toast -> `router.replace` without flag).
- Routing note: Intercepted routes for modal detail views must be scoped to the originating subtree (for example under `viewer/(..)garments`) rather than shared layout root, otherwise unrelated navigations/redirects (like post-save from `/editor`) can be intercepted and render modal overlays unexpectedly.
- Editor enum UX note: For schema-enum selects (for example `style`/`formality`), include the current persisted value in rendered options when it is not an exact option match; otherwise legacy/case-variant values render as blank in edit mode and trigger false "required" save errors.
- Enum canonicalization note: When hydrating editor state, normalize persisted enum-backed values case-insensitively to schema enums (for example `Vintage` -> `vintage`) before rendering/select binding; keep raw fallback only when no canonical option exists.
- Taxonomy migration note: When replacing controlled enum vocab (for example `formality`), update `schema.json` and provide a transaction-safe SQL remap script that (a) inserts canonical lookup rows, (b) remaps existing FK references, (c) removes unreferenced legacy rows, and (d) fails fast if non-canonical references remain.
- Style taxonomy note: If removing style options from schema enums, pair UI enum removal with explicit DB remap for affected styles (for example `casual`/`smart casual`) so existing garments remain editable and never fail server-side style validation.
- Controlled-vocab typo note: If an enum label typo ships (`Elevated Causal`), correct both app schema and DB lookup values with a dedicated follow-up migration that remaps existing foreign keys and removes the typo row safely.
- Navigation cache note: If edit forms show stale/missing values only on client navigation (but recover on hard refresh), disable prefetch on edit-entry links and run a one-time `no-store` reconciliation fetch on editor mount for the target record.
- Viewer search UX note: Implemented a `Cmd/Ctrl+K` command-style dialog on `/viewer` using shadcn `CommandDialog`, with client-side case-insensitive partial matching across `model`, `type`, and `brand`, thumbnail-first result rows, and direct navigation to `/garments/[id]`.
- Routing behavior note: In `/viewer`, command-palette result selection must use hard navigation (`window.location.assign`) when the expected outcome is full garment detail page; soft `router.push` can trigger intercepted modal routes.
- CMDK performance note: For large local lists in `cmdk`, defer filtering until query length >= 3 and apply a short input debounce (~120ms) to remove perceived keystroke lag.
- CMDK UX note: Highlighting matched substrings in results (model/type/brand) improves scan speed; implement with regex split + escaped query and style matches with a yellow background.
- Viewer quick-filter note: Added season quick filters (`winter|summer|fall|spring`) tied to `suitable_weather`, and persisted selection via `season` query param so filter state survives reload/share links.
- Viewer season quick-filter UX note: Replaced text chips with icon-only buttons (snowflake/sun/leaf/flower) while preserving accessible labels via `aria-label` + `title`.
- Viewer season control UX note: Consolidated season quick filters into a single dropdown trigger, showing vertically stacked season icons in a shadcn `DropdownMenu` to reduce toolbar clutter.
- AI travel planner note: Added `/ai-look` "Pack for Travel" mode with structured inputs (`destination`, `startDate`, `endDate`, `reason`), per-day weather enrichment (forecast + seasonal fallback), day-by-day look generation, strict no-repeat for first 4 days, and partial-plan return via `skippedDays`.
- Travel packing rule note: Updated travel planner constraints so first-4-day no-repeat excludes bottoms and footwear, footwear is capped to one pair across the trip, and day 1 + final day are explicitly generated as airport/commute-appropriate looks.
- Travel weather fallback note: When exact API forecast is unavailable for requested dates, planner now queries the LLM for destination/month average climate conditions and uses that for day-level weather intent before falling back to deterministic seasonal inference.
- Travel strictness note: Added hard place/occasion gating per day in travel planning (pre-filter eligible wardrobe + post-validate final lineup), so transit days require airport/commute tags and stay days follow strict reason-specific tags (office/business or vacation city/active with conditional beach).
- AI pipeline consistency note: Updated travel mode to match single-look architecture by adding a per-day Step 1 intent-interpretation pass (canonical structured intent) before Step 2 recommendation generation.
- Travel robustness note: For one-footwear-across-trip constraints, add deterministic post-processing to normalize model output (collapse multi-footwear selections to a single locked pair) before deciding to skip a day.
- Travel rule refinement: Footwear-lock now applies to stay days only (commute days exempt), and all garments used on travel days are reserved from reuse on in-between stay days.
- Travel constraint update: Removed the first-4-day no-repeat rule entirely; travel planning now allows repeats as needed while keeping strict place/occasion, commute-reserve, and footwear constraints.
- Travel office-mapping note: Expanded Office strict constraints to include additional acceptable places (`Workshop`, `Creative Studio / Atelier`, `Metropolitan / City`) and occasion (`Casual Social`) while retaining office/business options.
- Travel transit-day reliability note: Enforced strict eligible-ID pool filtering before validation and added last-travel-day fallback to reuse day-1 transit lineup (when still eligible) to avoid unnecessary skips under identical transit constraints.

## 2026-02-09
- Context: Travel pack agent was repeating looks across days and occasionally returning incomplete outfits without top-bottom-footwear coverage.
- What went right: Added deterministic post-generation normalization (core silhouette enforcement + top-to-bottom ordering + anti-duplicate/overlap checks) so model variance no longer directly leaks into output quality.
- What went wrong: Existing travel fallback intentionally reused day-1 lineup on final travel day, which reintroduced repeats even when alternatives existed.
- Correction applied: Removed final-day forced reuse behavior and replaced it with diversity-aware retries plus strict duplicate rejection when fresh pool depth is sufficient.
- Optimization note: Large eligible wardrobes were causing prompt bloat and repeated high-salience picks; fixed by scoring and capping a travel-day candidate subset (category quotas + novelty weighting) before model generation.
- Reliability note: Single-look mode now also applies deterministic silhouette completion and validation so responses consistently include top + bottom + footwear when wardrobe data permits it.
- Travel-pack completeness note: Updated travel mode to require four garment categories per day (`outerwear` + `top` + `bottom` + `footwear`), with explicit prompt rule, schema minimum of 4 IDs, and deterministic server-side enforcement/validation.
- Office baseline update note: Travel Office mode now favors styles `minimalist`/`vintage`/`classic`, formality `Elevated Casual` (fallback `Business Casual`), and occasions `Casual Social`/`Date Night / Intimate Dinner`/`Outdoor Social / Garden Party`; strict Office-day occasion gating was aligned to the same set so the preference is enforceable in eligibility filtering.
- Stats UI clarity note: In Coverage and Gaps, truncating each section to 6 rows caused confusion against full coverage totals (for example 9/9 while showing only 6). Updated UI to render all options in each section.
- AI Look tab UX note: Replaced the mode toggle-like control with semantic tabs rendered outside the main card (`role=tablist`/`tab`), and removed redundant main-card title/subtitle to reduce visual noise.
- Travel packing constraint note: Added a hard single-outerwear rule for travel mode (one jacket/coat across departure, stay, and return days), including trip-wide preselection of an outerwear candidate that satisfies each day’s place/occasion/weather constraints plus deterministic per-day lock validation.
- Travel rule interaction fix: commute-day reservation previously blocked the locked trip outerwear on stay days, causing false one-outerwear failures; fixed by exempting the locked outerwear from transit reservation blocking and from transit-reserved insertion.
- Travel loading UX note: Added full-structure skeletons for `/ai-look` travel mode that render one day-card placeholder per requested travel day while plan generation is pending, reducing layout shift when results hydrate.
- AI tab state UX note: Scoped result rendering by active mode so travel output/skeletons only show in `Pack for Travel` and single-look output only shows in `AI Look`, preventing cross-tab visual leakage.
- AI single-look guardrail note: Enforced fixed four-piece output (`outerwear + top + bottom + footwear`) with deterministic category-based normalization to prevent invalid category duplication (for example two pants) in `/ai-look` single mode.
- AI single-load UX note: Added screenshot-matching loading skeletons for `AI Look` results (title bar, intent-details strip, 4 lineup tiles, rationale lines) and clear previous results at request start to reduce layout shift.

## 2026-02-10
- Security hardening note: `/api/ai-look` now enforces a server-side maximum travel span (21 days) before any expensive per-day generation path runs, preventing single-request cost amplification.
- Rate-limit hardening note: Replaced owner API limiting from in-memory/IP-keyed only to owner-scoped persistent DB-backed windows (minute + hour) to resist multi-instance bypass; keep an in-memory fallback path only for DB limiter outages to avoid feature downtime.
- UI overflow note: `AI Look` page had baseline vertical scroll due to `min-h-screen` under a sticky `h-16` top nav; fixed by switching container min-height to `calc(100vh - 4rem)`/`calc(100dvh - 4rem)` so idle tab no longer overflows.
- CMDK export note: Added a new `Actions` command in `/viewer` command palette for `Export Wardrobe as JSON` with a right-aligned `J` chip; selecting it switches the palette into a dedicated export view (garment list hidden), includes a back icon in the input bar to return to normal search, and a copy icon/button to copy the full JSON payload.
- CMDK export UX refinement: In export view, removed active command input and replaced it with fixed helper text `Back to search` so users don’t interact with search while viewing command output.
- CMDK export sizing fix: Export-result container had `max-h-[70vh]`, which made the dialog larger than normal search mode; changed to the same results cap (`max-h-[300px]`) as command list so palette dimensions stay consistent across views.
- CMDK export polish: Converted export results panel to a fixed-height flex layout so textarea spacing at the bottom stays comfortable, and removed command-root focus outline to prevent transient gray border artifacts after executing export command.
- CMDK shortcut refinement: Limited export keyboard shortcut to uppercase `J` only; lowercase `j` is no longer intercepted so it can be used as normal search input text.

## 2026-02-11
- Stats caching correction note: `/stats` previously consumed production `unstable_cache` data and could remain stale indefinitely when DB changes occurred outside server actions; fixed by forcing fresh reads in stats (`getWardrobeData({ forceFresh: true })`) and marking the route dynamic.
- Cache resilience note: Added a 5-minute TTL (`revalidate: 300`) to shared `getWardrobeData()` production cache so viewer/API consumers self-heal from out-of-band DB updates even without explicit `revalidateTag`.
- AI rationale consistency note: `/api/ai-look` previously returned model-authored rationale generated before lineup normalization, causing garment-name drift versus final `lineup`; fixed by generating rationale server-side from finalized lineup + canonical intent/weather context for both single and travel modes.
- AI debugging note: Added explicit server log for single-look Step 1 interpreter output (`[ai-look][single][step-1][interpreted-intent]`) to inspect raw LLM intent JSON before recommendation generation.
- AI debugging refinement note: Added companion server log for normalized canonical intent (`[ai-look][single][step-1][canonical-intent]`) so raw-vs-canonical mapping can be compared in one request.
- AI tuning note: Increased single-look Step 1 interpreter temperature from `0` to `0.8` to allow more varied intent inference while keeping schema/canonical guardrails.
- Taxonomy label update note: Replaced place enum label `Hospitality (Indoor)` with `Home / WFH` in `public/schema.json` and added SQL migration script `scripts/sql/rename-hospitality-indoor-to-home-wfh.sql` to remap `suitable_places` rows and junction-table references safely.
- Weather grounding note: Single-look mode now parses explicit prompt dates (for example `February 11th 2026`), resolves weather deterministically by location/date server-side, logs resolution metadata, and overrides canonical weather intent with resolved tags when available to prevent generic `all season` drift.
- Weather grounding refinement note: Removed single-look prompt date parsing and date-based weather resolution; single-look now always resolves weather from current conditions at the indicated place (including `today`/`now`/`tomorrow` prompts) and uses that to override generic interpreted weather when available.
- AI temperature tuning note: Set two-step generation temperatures to `0.3` for Step 1 intent interpretation and `0.7` for Step 2 recommendation in both single-look and travel flows.
- Rationale tone note: Refined server-generated rationale to be crisp and intent-focused only (occasion/place/weather/formality/style fit), removing garment-level descriptions and material callouts.
- Rationale polish note: Further improved rationale readability by removing technical prefixes (for example `Intent focus`), de-duplicating weather statements, and producing concise natural-language weather highlights without truncation artifacts.
- Rationale depth note: Expanded server-generated rationale into a richer multi-sentence narrative (context, day-flow fit, style/formality fit, weather fit, and cohesion) while still avoiding garment/material descriptions and technical-sounding phrasing.
- Panelist diversity note: Single-look Step 2 now attempts six candidates (`2 per panelist`), validates/normalizes them server-side, reranks with recency and overlap penalties, and returns one top look per panelist to reduce near-duplicate outputs for similar prompts.
- Personalization memory note: Added persistent `ai_look_lineup_history` (single mode) so repeated requests can be diversified without making generation brittle; history read/write failures are treated as non-fatal warnings.
- UI clarity note: Replaced single-look one-result card with a manual one-card carousel (prev/next + dots) to expose three panelist perspectives without changing the page layout density.
- Migration workflow note: When users prefer explicit schema control, provide a dedicated idempotent SQL script (`scripts/sql/create-ai-look-lineup-history.sql`) even if runtime auto-create guards exist.
- Migration enforcement note: Removed runtime auto-create for `ai_look_lineup_history`; single-look recency memory now depends on running `scripts/sql/create-ai-look-lineup-history.sql` before use.
- Robustness note: Guarded single-look client rendering against malformed/partial API payloads by parsing response shape and using safe array access before `.map`, preventing runtime crashes during iterative API changes.
- Product-direction note: Reverted from panelist multi-look output to a single-output diversified reranker flow (up to 6 candidates -> 1 `primaryLook`) to reduce repetition without forcing multi-card UX.
- Rationale integrity note: Removed model-authored rationale sentence appending in single-look finalization and strengthened weather-note cleanup (`not found`/assumption patterns + weather sentence stripping when live weather exists) to prevent lineup drift and repetitive weather phrasing.
- Diversity hardening note: Added explicit recent-signature avoidance in step-2 prompting plus hard no-repeat/low-overlap selection filters (when alternatives exist), and injected recent-ID novelty bias into normalization/fallback scoring to reduce back-to-back duplicate looks.
- Travel persistence note: Added cross-request travel-day anti-repeat memory using `ai_look_travel_day_history` keyed by a normalized travel fingerprint (`destination|reason|startDate|endDate`), with hard historical-signature avoidance when alternatives exist, graceful fallback when they do not, and best-effort history read/write logging.
- Travel reliability note: Added an extra relaxed-diversity fallback attempt for travel-day generation when silhouette/packing validity fails, so strict day constraints remain enforced while avoiding avoidable `skippedDays` regressions introduced by diversity pressure.
- Feature-scoping note: For anchored AI look requests, define strict vs soft anchor semantics and preserve non-anchored path parity in spec first; this avoids regressions in single/travel flows when introducing context-bound CMDK commands.
- Anchored look implementation note: Added garment-detail CMDK action (`Generate look around this garment`) that routes to `/ai-look` with anchor params, plus strict/soft anchor enforcement in single-look candidate normalization and fallback while keeping non-anchored behavior unchanged.
- Garment CMDK UX note: Added garment-detail action commands for JSON export (in-dialog copyable textarea), copy link, next/previous navigation, and viewer handoff (`Find Matching Pieces`), while preserving viewer-style search threshold behavior (`>=2` chars) and uppercase-only hotkeys for `E`/`G`.
- Command palette visual note: Added consistent leading icons across viewer and garment CMDK action items while keeping right-side shortcut chips, improving scanability without changing command semantics.
